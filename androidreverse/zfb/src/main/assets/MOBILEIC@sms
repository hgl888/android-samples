{"time":"0021","tplId":"MOBILEIC@sms","publishVersion":"150603","tag":"MOBILEIC","name":"sms","data":{"tag":"html","children":[{"tag":"head","children":[{"tag":"meta","src":"VIVerifyCore.bundle/mic.i18n","type":"i18n"},{"tag":"meta","src":"android-phone-securitycommon-verifyidentitybiz/mic.i18n","type":"i18n"},{"tag":"link","rel":"stylesheet","href":"VIVerifyCore.bundle/mic.css"},{"tag":"link","rel":"stylesheet","href":"android-phone-securitycommon-verifyidentitybiz/mic.css"},{"tag":"script","src":"js/cashier-safeprotect-sms-flex.js"},{"tag":"script","src":"VIVerifyCore.bundle/vi-amc.js"},{"tag":"script","src":"VIVerifyCore.bundle/mic.js"},{"tag":"script","src":"android-phone-securitycommon-verifyidentitybiz/vi-amc.js"},{"tag":"script","src":"android-phone-securitycommon-verifyidentitybiz/mic.js"},{"tag":"script","children":[{"text":"//别名\n    var rpc = amc.rpcData;\n    var show = amc.fn.show;\n    var getTag = amc.fn.getById;\n\n    //### 这个页面与cashier-sms视觉类似，但是参数差异较大，且为安全服务化页面。因此单独列出，省得兼容时的麻烦。\n    var countDown = 60;\n    var codeCount = 6;\n    var countDownNum = countDown;\n    var timer;\n\n    var smsread = {\n        'template': '{{code}}(\\\\d{4,6})',\n        'tempGroup': '1',\n        'rules': ['95188', '106575258188', '106980095188', '106575170001', '106575552766', '106575552788', '10655057868', '10655059666', '106590571868', '106590202028', '106575000086', '1069099999', '95559', '95580', '95528', '95508', '95561'],\n        'readTime': '180'\n    };\n\n    //### 密码框输入响应\n    function onPwdInput() {\n        var input = getTag('pwd');\n        input.style.cssText = 'color:#000';\n        var submit = getTag('submit');\n        submit.disabled = !(input.value.length == codeCount);\n    }\n\n    function init() {\n        var nav = amc.fn.getNav(amc.res.navBack, '{{return}}', '{{id_validate}}', null, null, onBack, null);\n        getTag('body').insertBefore(nav, getTag('titleBox'));\n\n        if (rpc.mobile_no) {\n            getTag('mainTitle').innerText = amc.fn.i18nPlaceholderReplace('{{phone_sms_full}}', rpc.mobile_no);\n        } else { // 如果服务端拿不到手机号则返回空字符串@东隅(安全服务化服务端),此情况下显示如下文案,@因梦(安全服务化PD)\n            getTag('mainTitle').innerText = '{{phone_sms}}';\n        }\n\n        // Android平台没有白色菊花，需要特殊处理\n        if (amc.isAndroid) {\n            getTag('loading').src = amc.path + 'alipay_msp_indicator_white_loading';\n        }\n\n        //### 短信倒计时\n        getTag('resendBtn').disabled = true;\n        if (rpc.countDown > 0) {\n            countDown = rpc.countDown;\n        }\n        if (rpc.codeCount > 0) {\n            codeCount = rpc.codeCount;\n        }\n        reCountDown();\n        countDownFuc();\n        //### Android自动读取短信\n        if (amc.isAndroid) {\n            readSms();\n        }\n        getTag('pwd').focus();\n\n        if (true !== Boolean(rpc.HAS_OTHERS)) {\n            var parentNode = document.getElementById('mainBody');\n            var othersDiv = document.getElementById('others');\n            parentNode.removeChild(othersDiv);\n        }\n        processResendData(rpc.code, rpc.message);\n    }\n\n    //### Android系统自动读取短信帮用户读入\n    function readSms() {\n        var obj = {\n            'action': {\n                'name': 'loc:readsms'\n            }\n        };\n        var submitObj = {\n            'smsread': smsread\n        };\n        obj['action']['params'] = submitObj;\n        document.asyncSubmit(obj, function(data) {\n            if (data['sms']) {\n                getTag('pwd').value = data['sms'];\n                onPwdInput();\n            }\n        });\n    }\n\n    function submitReSend() {\n        //### 倒计    触发提交操作\n        if (countDownNum > 0) {\n            return;\n        }\n\n        var obj = {};\n        obj['eventName'] = 'vi_rpc_validate';\n        obj['moduleName'] = 'CUSTOMIZED_SMS';\n        obj['actionName'] = 'RESEND_SMS';\n\n        document.asyncSubmit(obj, function(data) {\n            data = data || {};\n            data['pageloading'] = '0';\n            amc.fn.shouldShowBtnIndicator(data, 'submit', 'loading');\n            try{\n                viData = JSON.parse(data['data']);\n            }catch(error){\n                print(\"fail to get viData: \"+ error.message);\n            }\n            viData = viData || {};\n            if (true !== Boolean(data['success'])) {\n                mic.fn.onBackWithResponse(data);\n            } else {\n                processResendData(viData['code'], viData['message']);\n            }\n        });\n\n        getTag('resendBtn').disabled = true;\n        reCountDown();\n        getTag('pwd').value = '';\n        getTag('submit').disabled = true;\n    }\n\n    function reCountDown(){\n        countDownNum = countDown;\n\n        // 防止之前的timer还没被清掉\n        if (timer) {\n            clearInterval(timer);\n            timer = 0;\n        }\n        timer = setInterval(countDownFuc, 1000);\n    }\n\n    function processResendData(code, message) {\n        print(\"processResendData code: \" + code + \", message: \" + message);\n        message = message || '人气太旺了，请稍后再试';\n        if ('VALIDATECODE_SEND_SUCCESS' === code) {\n            //nothing to do\n        } else {\n            enableResend();\n            if ('VALIDATECODE_SEND_TIMES_LIMIT' === code) {\n                document.alert({\n                    \"title\": '',\n                    \"message\": message,\n                    \"button\": '我知道了'\n                }, function() {});\n            } else {\n                document.alert({\n                    \"title\": '',\n                    \"message\": message,\n                    \"button\": '我知道了'\n                }, function() {});\n            }\n        }\n    }\n\n    //### 倒计时1\n    function countDownFuc() {\n        if (countDownNum > 0) {\n            getTag('resendBtn').innerText = amc.fn.i18nPlaceholderReplace('{{resend_after_full}}', countDownNum);\n            countDownNum -= 1;\n        } else {\n            enableResend();\n        }\n    }\n\n    function enableResend(){\n        countDownNum = 0;\n        getTag('resendBtn').innerText = '{{resend_sms}}';\n        getTag('resendBtn').disabled = false;\n        if (timer) {\n            clearInterval(timer);\n            timer = 0;\n        }\n    }\n\n\n    //### 确认按钮,提交业务数据\n    function submitInfo() {\n        //### 提交前隐藏输入框\n        getTag('pwd').blur();\n\n        var obj = {};\n\n        obj['eventName'] = 'vi_rpc_validate';\n        obj['moduleName'] = 'CUSTOMIZED_SMS';\n        obj['actionName'] = rpc.verifyAction;\n        //### 设置用户提交的参数\n        var submitObj = {\n            'ackCode': getTag('pwd').value\n        };\n        obj['params'] = submitObj;\n\n        document.asyncSubmit(obj, function(data) {\n            data['pageloading'] = '0';\n            amc.fn.shouldShowBtnIndicator(data, 'submit', 'loading');\n\n            var verifyMessage = data['verifyMessage'] || '人气太旺了，请稍后再试';\n            if ('VALIDATECODE_VALIDATE_SUCCESS' === data['verifyCode']) {\n                mic.fn.onBackWithResponse(data);\n            } else {\n                //verify failed\n                getTag('pwd').value = '';\n                if ('VALIDATECODE_FAILURE' === data['verifyCode']) {\n                    document.toast({\n                        text: verifyMessage,\n                    }, function() {});\n                } else if ('VALIDATECODE_EXPIRED' === data['verifyCode']) {\n                    document.toast({\n                        text: verifyMessage,\n                    }, function() {});\n                    getTag('resendBtn').disabled = true;\n                } else if ('VALIDATECODE_VALIDATE_TIMES_LIMIT' === data['verifyCode']) {\n                    document.alert({\n                        \"title\": '',\n                        \"message\": verifyMessage,\n                        \"button\": '我知道了'\n                    }, function() {\n                        mic.fn.onBackWithResponse(data);\n                    });\n                } else {\n                    mic.fn.onBackWithResponse(data);\n                }\n            }\n\n        });\n\n        amc.fn.shouldShowBtnIndicator({\n            'pageloading': '1'\n        }, 'submit', 'loading');\n    }\n\n    //### 退出\n    function onBack() {\n        mic.fn.onBack();\n    }\n\n    function onKeyDown() {\n        if (event.which == 4) {\n            onBack();\n        }\n    }","tag":"text"}]}]},{"id":"body","onload":"init()","tag":"body","children":[{"id":"titleBox","tag":"div","children":[{"id":"mainTitle","tag":"label","css":"amc-font-m amc-flex-1"}],"css":"amc-pd-lr amc-full-title"},{"id":"mainBody","tag":"div","children":[{"tag":"div","css":"amc-1px-line"},{"tag":"div","children":[{"tag":"div","children":[{"tag":"label","children":[{"text":"{{code}}","tag":"text"}],"css":"amc-cell-l-text amc-flex-1 amc-ellipsis-2-line"}],"css":"amc-cell-l-box"},{"tag":"div","children":[{"id":"pwd","autofocus":"true","placeholder":"{{sms_code}}","tag":"input","value":"","type":"number","css":"amc-input","oninput":"onPwdInput()"}],"css":"amc-cell-m-box"},{"tag":"div","css":"amc-cell-v-line"},{"tag":"div","children":[{"id":"resendBtn","tag":"button","children":[{"text":"{{resend_sms}}","tag":"text"}],"onclick":"submitReSend()","css":"amc-input amc-theme-color amc-btn-no-bg","disabled":"disabled"}],"css":"amc-resend-btn-w"}],"css":"amc-cell amc-pd-l"},{"tag":"div","css":"amc-1px-line"},{"tag":"div","css":"amc-abs-space-v-xxl"},{"tag":"div","children":[{"id":"loading","tag":"img","src":"indicatior","css":"amc-loading-img amc-text-white-clolor amc-hidden"},{"id":"submit","tag":"button","children":[{"text":"{{next}}","tag":"text"}],"onclick":"submitInfo()","css":"amc-btn-primary","disabled":"true"}],"css":"amc-margin-lr amc-align-center amc-justify-center amc-btn-primary"},{},{"id":"others","tag":"div","children":[{},{"id":"othersBtn","tag":"div","children":[{"id":"btnText","tag":"label","children":[{"text":"选择其他校验方式","tag":"text"}],"css":"amc-text-color-blue amc-font-m"}],"onclick":"mic.fn.changeModule();"}],"css":"amc-pd-lr amc-margin-t amc-justify-end mic-other-touch-area-height"}],"css":"amc-main mic-scroll-fullscreen"}],"onkeydown":"onKeyDown();","css":"mic-body-opacity"}]},"format":"JSON","tplVersion":"5.1.2"}