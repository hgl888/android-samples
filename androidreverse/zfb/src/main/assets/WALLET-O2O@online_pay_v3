{"time":"0079","tplId":"WALLET-O2O@online_pay_v3","publishVersion":"150603","tag":"WALLET-O2O","name":"online_pay_v3","data":{"tag":"html","children":[{"tag":"head","children":[{"content":"text/html; charset=UTF-8","tag":"meta","http-equiv":"Content-Type"},{"tag":"style","children":[{"text":".body {\n            display: flex;\n            flex-direction: column;\n            background-color: #ffffff;\n            height: 100%;\n            margin: 0;\n            padding: 0;\n        }\n\n        .container {\n            flex: 1;\n            display: flex;\n            overflow: scroll;\n            flex-direction: column;\n        }\n\n        .payment-label {\n            font-size: 14px;\n            color: #000;\n        }\n\n        .payment-label-big {\n            font-size: 16px;\n            color: #000;\n        }\n\n        .money-label {\n            font-size: 15px;\n            color: #333333;\n        }\n\n        .amc-btn-primary {\n            margin-top: 15px;\n            background-color: #FB6165;\n            border: 0;\n            border-radius: 4px;\n            color: #fff;\n            font-size: 18px;\n            height: 44px;\n        }\n\n        .amc-btn-primary:active {\n            color: #fff;\n            background-color: #E06065;\n        }\n\n        .amc-btn-primary:disabled {\n            background-color: #FB6165;\n            color: rgba(255, 255, 255, 0.5);\n        }\n\n        .bill-info {\n            margin: 0px 15px 5px 15px;\n            flex-direction: column;\n        }\n\n        .money-input {\n            font-size: 20px;\n            color: #333333;\n            flex: 1;\n            text-align: right;\n            margin-right: 10px;\n            margin-left: 10px;\n            border: none;\n            background-color: #F5F5F8;\n            placeholder-font-size: 13px;\n            placeholder-color: #cccccc;\n            padding-left: 0px;\n            padding-right: 0px;\n            height: 44px;\n        }\n\n        .big-money-input {\n            font-size: 30px;\n            placeholder-font-size: 16px;\n            height: 58px;\n        }\n\n        .split-line {\n            height: 1PX;\n            background-color: #E5E5E5;\n        }\n\n        .input-box {\n            height: 44px;\n            padding-left: 10px;\n            align-items: center;\n            background-color: #F5F5F8;\n            border-radius: 4px;\n        }\n\n        .money-input-box {\n            height: 58px;\n        }\n\n        .discount-info {\n            width: 100%;\n            padding-left: 15px;\n            padding-right: 15px;\n            flex-direction: column;\n            align-self: flex-start;\n        }\n\n        .discount-title {\n            flex: 1;\n            font-size: 13px;\n            color: #A5A5A5;\n            margin-right: 5px;\n        }\n\n        .discount-title-big {\n            margin-top: 3px;\n            font-size: 15px;\n            margin-bottom: 3px;\n        }\n\n        .discount-title-best {\n            color: #F96268;\n        }\n\n        .discount-tip {\n            flex: 1;\n            font-size: 13px;\n            color: #A5A5A5;\n            margin-right: 10px;\n        }\n\n        .discount-item-container {\n            flex-direction: column;\n        }\n\n        .discount-item {\n            margin: 4px 0 4px 0;\n            align-items: center;\n            flex: 1;\n        }\n\n        .discount-title-wrap {\n            flex: 1;\n        }\n\n        .discount-money {\n            font-size: 15px;\n            color: #F96268;\n        }\n\n        .discount-money-big {\n            font-size: 17px;\n        }\n\n        .payment-container {\n            padding: 13px 15px 10px 15px;\n            background-color: #fff;\n            flex-direction: column;\n        }\n\n        .alipay-discount-container {\n            flex: 1;\n            flex-direction: column;\n            margin-top: -1px;\n            display: none;\n        }\n\n        .payment-info {\n            flex-direction: row;\n            align-items: center;\n            display: none;\n        }\n\n        .discount-subtitle {\n            margin-top: 13px;\n            margin-bottom: 6px;\n            color: #333;\n            font-size: 13px;\n        }\n\n        .discount-title-desc {\n            margin-top: 12px;\n            margin-left: 7px;\n            margin-bottom: 6px;\n            color: #999;\n            font-size: 12px;\n        }\n\n        .payment-money {\n            height: 36px;\n            font-size: 30px;\n            color: #F96268;\n            flex: 1;\n            text-align: right;\n        }\n\n        .discount-title-bar {\n            display: none;\n            align-content: center;\n            align-items: center;\n        }\n\n        .payment-tips-wrap {\n            padding-top:10px;\n            justify-content: center;\n            align-items: center;\n        }\n\n        .payment-tips {\n            font-size: 11px;\n            color: #A5A5A5;\n            display: none;\n        }\n\n        .address {\n            height: 15px;\n            margin: 9px 0 9px 0;\n            justify-content: center;\n            align-items: center;\n        }\n\n        .address-icon {\n            width: 9px;\n            height: 12px;\n            margin-right: 5px;\n        }\n\n        .address-text {\n            font-size: 11px;\n            color: #888888;\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            max-width: 75%;\n        }","tag":"text"}],"type":"text/css"},{"tag":"script","children":[{"text":"var $ = function (sel) {\n            return document.getElementById(sel);\n        };\n\n        // 工具方法\n        window.Utils = {\n            isValidArray: function (arr) {\n                return arr && arr.length;\n            },\n            // 根据字符串描述创建元素(只能是单个无素)\n            // eg: 输入字符串: \"div#J-xxx.class-name[text=123,123;&xxx=123]\"\n            //     生成       div id=\"J-xxx\" class=\"class-name\" 123/div\n            createElement: function (str) {\n                var splitSymbol = \";&\";\n\n                var tagName = /^\\w+/.exec(str)[0];\n                var el = document.createElement(tagName);\n                if (!el) return;\n\n                var className = /\\.([\\w-\\s]+)/gi.exec(str);\n                var idName = /#((\\-|[\\w])+)/i.exec(str);\n                if (className && className[1]) {\n                    el.className = className[1];\n                }\n                if (idName && idName[1]) el.id = idName[1];\n\n                if (str.indexOf('[') != -1) {\n                    var attrs = /\\[(.+)\\]/.exec(str)[1].split(splitSymbol);\n                    for (var i = 0, l = attrs.length; i < l; i++) {\n                        var attr = attrs[i].split('=');\n                        if (attr.length != 2) continue;\n                        if (attr[0] == 'text') {\n                            el.innerText = attr[1];\n                        } else {\n                            el[attr[0]] = attr[1];\n                        }\n                    }\n                }\n                return el;\n            },\n\n            formatMoneyOnInput: function (input) {\n                // 为空不做任何处理\n                if (input.value == '') return;\n\n                // 排除非数字字符\n                if (input.value.match(/[^0-9\\.]/g)) {\n                    input.value = input.value.replace(/[^0-9\\.]/g, '');\n                }\n\n                if (input.value.indexOf('.') != -1) {\n                    if (input.value == '.') {\n                        input.value = '0.';\n                    } else {\n                        var numbs = input.value.split('.');\n                        if (numbs.length > 2) numbs.length = 2;\n                        numbs[0] = numbs[0] * 1 + '';\n                        // 限制长度\n                        if (numbs[0].length > 8) {\n                            numbs[0] = numbs[0].substr(0, 8);\n                        }\n                        if (numbs[1] && numbs[1].length > 2) {\n                            numbs[1] = numbs[1].substring(0, 2);\n                        }\n                        if (input.value != numbs.join('.')) {\n                            input.value = numbs.join('.');\n                        }\n                    }\n                } else {\n                    if (input.value != '') {\n                        if (input.value * 1 + '' != input.value) {\n                            input.value *= 1;\n                        }\n                        // 限制长度\n                        if (input.value.length > 8) {\n                            input.value = input.value.substr(0, 8);\n                        }\n                    }\n                }\n            },\n\n            formatMoneyOnBlur: function (input) {\n                // 为空不做任何处理\n                if (input.value == '') return;\n\n                // 排除非数字字符\n                input.value = input.value.replace(/[^0-9\\.]/g, '');\n\n                // 格式化为金钱样式 ( 0.00 )\n                if (input.value.indexOf('.') != -1) {\n                    var numbs = input.value.split('.');\n                    if (numbs.length > 2) numbs.length = 2;\n                    numbs[0] = numbs[0] * 1 + '';\n                    // 限制长度\n                    if (numbs[0].length > 8) {\n                        numbs[0] = numbs[0].substr(0, 8);\n                    }\n                    if (numbs[1] && numbs[1].length > 2) {\n                        numbs[1] = numbs[1].substring(0, 2);\n                    } else if (numbs[1].length < 2) {\n                        numbs[1] += '00';\n                        numbs[1] = numbs[1].substr(0, 2);\n                    }\n                    input.value = numbs.join('.') * 1;\n                } else {\n                    // 消除前导多余的零\n                    input.value *= 1;\n                    // 限制长度\n                    if (input.value.length > 8) {\n                        input.value = input.value.substr(0, 8);\n                    }\n                }\n            },\n\n            checkAmount: function () {\n                if (Node.noDiscountAmountInput.value * 1 > Node.totalAmountInput.value * 1) {\n                    document.invoke(\"toast\", {\n                        \"text\": \"不参与优惠金额不可大于总金额\",\n                        \"type\": \"none\"\n                    });\n                }\n                \n                \n                if (Node.totalAmountInput.value * 1 <= 0) {\n                    Node.paymentInfo.style.display = 'none';\n                    Node.paymentInfo.style.display = 'none';\n                } else {\n                    Node.paymentInfo.style.display = 'flex';\n                    Node.paymentInfo.style.display = 'flex';\n                }\n            },\n\n            mergeJSON: function (source, target) {\n                for (var attrName in source) {\n                    target[attrName] = source[attrName];\n                }\n            }\n        };\n\n        // 纯业务方法及参数\n        window.Biz = {\n\n            // ------------------------------------------我是服务端参数的分割线----------------------------------------\n            // 支付宝合作方id\n            partnerId: \"\",\n\n            // 来源标识\n            sourceFrom: \"\",\n\n            // 产品码\n            productCode: \"\",\n\n            // 标识id\n            pageTraceId: \"\",\n\n            // 商铺id\n            shopId: \"\",\n\n            // 查询匹配的优惠信息时传给后台,用于匹配服务端缓存的优惠列表\n            preQueryId: \"\",\n\n            // 生成订单时传给后单,用于匹配订单优惠信息\n            preCalculateId: \"\",\n\n            // 验签标识\n            sign: \"\",\n\n            // 商家手机号\n            mobileNo: \"\",\n\n            // 商家优惠列表(缓存RPC数据)\n            merchantDiscountList: [],\n\n            // 是否显示支付优惠区域(缓存RPC数据)\n            alipayDiscount: false,\n\n            // 服务端返回的剩余金额(缓存RPC数据)\n            remainderAmount: \"\",\n\n            // 标识第一次RPC是否成功\n            firstRPCBizSuccess: false,\n\n            // 地址栏\n            address: \"\",\n\n            // 收银员ID\n            cashierNo: \"\",\n\n            //  总金额 \n            totalCost: \"\",\n\n            //不打折金额\n            noDiscountCost: \"\",\n\n            // ------------------------------------------我是服务端参数的分割线----------------------------------------\n\n            // 查询优惠列表\n            queryDiscountList: function () {\n                document.invoke('showProgress', {\"titleLoading\": true});\n                document.invoke(\"rpc\", {\n                    \"operationType\": \"alipay.mobilecsa.queryOrderDiscount\",\n                    \"requestData\": [{\n                        \"productCode\": Biz.productCode,\n                        \"pageTraceId\": Biz.pageTraceId,\n                        \"partnerId\": Biz.partnerId,\n                        \"shopId\": Biz.shopId\n                    }]\n                }, function (rsp) {\n                    document.invoke('hideProgress');\n\n                    if (rsp.success) {\n                        var bizResult = rsp.result;\n                        if (bizResult.success) {\n                            Biz.firstRPCBizSuccess = true;\n\n\n                            // 更新需要缓存的业务数据\n                            Biz.preQueryId = bizResult.preQueryid;\n                            // 特殊逻辑,第一个RPC返回-1时,预计算ID也赋值为-1,并直接下单\n                            if (Biz.preQueryId == \"-1\") {\n                                Biz.firstRPCBizSuccess = false;\n                                Biz.preCalculateId = Biz.preQueryId;\n                            }\n                            Biz.merchantDiscountList = bizResult.merchantDiscountList;\n                            Biz.alipayDiscount = bizResult.alipayDiscount;\n\n                            Page.refreshDiscountAreaDisplay();\n\n                            if (Utils.isValidArray(Biz.merchantDiscountList)) {\n                                Page.MerchantDiscountList.create(Biz.merchantDiscountList);\n                            } else {\n                                Page.MerchantDiscountList.display('none');\n                            }\n                        } else {\n                            // 业务失败\n                            Page.refreshDiscountAreaDisplay();\n                        }\n                    } else {\n                        Page.refreshDiscountAreaDisplay();\n                    }\n                });\n            },\n\n            // 查询打折信息\n            queryMatchedDiscount: function () {\n                if (Node.totalAmountInput.value * 1 <= 0) {\n                    document.invoke(\"toast\", {\n                        \"text\": \"消费总金额必须大于等于零\",\n                        \"type\": \"none\"\n                    });\n                    return;\n                }\n\n                if (Node.noDiscountAmountInput.value * 1 > Node.totalAmountInput.value * 1){\n                    return;\n                }\n\n                // 第一个RPC不成功后,后续的不需要再去匹配优惠\n                if (!Biz.firstRPCBizSuccess) return;\n\n                // 清除之前缓存的预计算id\n                Biz.preCalculateId = \"\";\n\n                // 显示计算中效果\n                Page.showCounting();\n                document.invoke('showProgress', {\"titleLoading\": true});\n                // 查询能匹配的优惠条目\n                document.invoke(\"rpc\", {\n                    \"operationType\": \"alipay.mobilecsa.calculatePayPre\",\n                    \"requestData\": [{\n                        \"preQueryId\": Biz.preQueryId,\n                        \"partnerId\": Biz.partnerId,\n                        \"shopId\": Biz.shopId,\n                        \"productCode\": Biz.productCode,\n                        \"pageTraceId\": Biz.pageTraceId,\n                        \"totalCost\": Node.totalAmountInput.value,\n                        \"noDiscountCost\": Node.noDiscountAmountInput.value\n                    }]\n                }, function (rsp) {\n                    document.invoke('hideProgress');\n\n                    // 业务成功请除掉3秒后显示的toast效果\n                    if (Page.tipsTimer) {\n                        window.clearTimeout(Page.tipsTimer);\n                    }\n\n                    // 修改展示\n                    Page.updatePaymentDisplay(false);\n\n                    if (rsp.success) {\n\n                        var bizResult = rsp.result;\n                        //Page.updatePaymentDisplay(false);\n                        if (bizResult.success) {\n\n                            // 判断返回的金额和现在输入框的金额是否匹配；不匹配重新请求下。\n                            if (bizResult.totalCost != Node.totalAmountInput.value || bizResult.noDiscountCost != Node.noDiscountAmountInput.value) {\n                                print(\"总金额或者不打折金额数值不匹配\");\n                                Biz.queryMatchedDiscount();\n                            };\n\n                            // 更新数据\n                            Biz.preCalculateId = bizResult.preCalculateId;\n                            Biz.remainderAmount = bizResult.remainderAmount;\n\n                            //  亮亮显示商家优惠和支付宝优惠\n                            if (Utils.isValidArray(bizResult.merchantDiscountList) && Node.totalAmountInput.value * 1.0 > 0) {\n                                Page.MerchantDiscountList.highlight(bizResult.merchantDiscountList);\n                            } else {\n                                Page.MerchantDiscountList.reset();\n                            }\n                            if (Utils.isValidArray(bizResult.alipayDiscountList) && Node.totalAmountInput.value * 1.0 > 0) {\n                                Page.AlipayDiscountList.create(bizResult.alipayDiscountList);\n                            } else {\n                                Page.AlipayDiscountList.hasNoMore();\n                            }\n\n                            // 优惠金额\n                            Node.discountedAmount.innerText = bizResult.remainderAmount ?\n                                    bizResult.remainderAmount : Node.totalAmountInput.value;\n                        } else {\n                            // 匹配优惠失败不影响后面的买单\n                            Node.discountedAmount.innerText = Node.totalAmountInput.value;\n                            document.invoke(\"toast\", {\n                                \"text\": \"直接点击“确认付款”也可享受最高优惠哦~\",\n                                \"type\": \"none\"\n                            });\n                        }\n                    } else {\n                        // RPC失败,未能查询到匹配的优惠,但是不影响后面的支付,所以不做任何处理\n                        Node.discountedAmount.innerText = Node.totalAmountInput.value;\n                        if (!rsp.isFacedException) {\n                            document.invoke(\"toast\", {\n                                \"text\": \"直接点击“确认付款”也可享受最高优惠哦~\",\n                                \"type\": \"none\"\n                            });\n                        }\n                    }\n                });\n            },\n\n            // 创建订单并支付订单\n            createOrder: function (info) {\n                document.invoke(\"showProgress\", {\"isBlock\": true});\n                var deviceInfo = JSON.parse(document.getProp('deviceInfo'));\n                var enCodeCashierNo = encodeURIComponent(Biz.cashierNo);\n                document.invoke(\"rpc\", {\n                    \"operationType\": \"alipay.mobilecsa.createAlipayOrder\",\n                    \"requestData\": [{\n                        \"sign\": Biz.sign,\n                        \"shopId\": Biz.shopId,\n                        \"partnerId\": Biz.partnerId,\n                        \"productCode\": Biz.productCode,\n                        \"pageTraceId\": Biz.pageTraceId,\n                        \"sourceFrom\": Biz.sourceFrom,\n                        \"mobileNo\": Biz.mobileNo,\n                        \"preCalculateId\": Biz.preCalculateId,\n                        \"cashierNo\": enCodeCashierNo,\n                        \"totalCost\": Node.totalAmountInput.value,\n                        \"noDiscountCost\": Node.noDiscountAmountInput.value,\n                        \"clientIp\": deviceInfo.clientIp,\n                        \"clientId\": deviceInfo.clientId,\n                        \"clientMac\": deviceInfo.clientMac\n                    }]\n                }, function (rsp) {\n                    document.invoke(\"hideProgress\");\n                    // 结果返回则启用按纽\n                    Node.paymentButton.disabled = false;\n                    if (rsp.success) {\n                        var bizResult = rsp.result;\n                        if (bizResult.success) {\n                            document.invoke(\"pay\", {\n                                \"tradeNo\": bizResult.tradeNo,\n                                \"bizType\": \"trade\",\n                                \"suffix\": \"bizcontext=\\\"\\\"&needConfirm=\\\"true\\\"&biz_from=\\\"ali_barcode_pay\\\"&display_pay_result=\\\"false\\\"\"\n                            }, function (rsp) {\n                                if (rsp.status == 9000) {\n                                    // 收银成功\n                                    document.invoke('startApp', {\n                                        \"appId\": \"20000056\",\n                                        \"param\": {\n                                            \"actionType\": \"showSuccPage\",\n                                            \"payResult\": rsp.result,\n                                            \"status\": rsp.status\n                                        }\n                                    });\n                                    document.invoke(\"exit\", {\n                                        \"animated\": false\n                                    });\n                                } else {\n                                    Page.reset();\n                                    Biz.queryDiscountList();\n                                }\n                            });\n                        } else {\n                            document.invoke(\"toast\", {\n                                \"text\": bizResult.desc ? bizResult.desc : \"系统繁忙，请稍后再试\",\n                                \"type\": \"none\"\n                            });\n                            Page.reset();\n                            Biz.queryDiscountList();\n                        }\n                    } else {\n                        // 创建订单RPC无结果\n                        if (!rsp.isFacedException) {\n                            document.invoke(\"toast\", {\n                                \"text\": \"网络错误,请稍候再试\",\n                                \"type\": \"fail\"\n                            });\n                        }\n                    }\n                });\n            }\n        };\n\n        // 操作页面相关\n        window.Page = {\n\n            // 用于填鸟巢的onreload的坑\n            firstReloaded: true,\n\n            // 标识是否为大屏幕iPhone设备(iPhone 6 plus以上)\n            isBigIOSDevice: false,\n\n            // 之前的输入总金额，用于判定输入数据是否需要拉rpc请求\n            lastTotalAmount: 0.0,\n\n            // 之前的输入不参与折扣金额，用于判定输入数据是否需要拉rpc请求\n            lastNoDiscount: 0.0,\n\n            // 加载大屏iOS设备样式\n            // TODO: 未来需要干掉这个方法\n            // 虽然方案很恶心,但是已经答应PD了,鸟巢容器第一个项目不应该让业务方失望啊……\n            loadBigIOSDeviceStyle: function () {\n                if (!Page.isBigIOSDevice) return;\n\n                var style = {\n                    \".payment-label\": \"font-size:15px;\",\n                    \".payment-label-big\": \"font-size:18px;\",\n                    \".money-input\": \"height: 50px;font-size:22px;placeholder-font-size:15px;\",\n                    \".big-money-input\": \"height:75px;font-size:28px;placeholder-font-size:17px;\",\n                    \".input-box\": \"height:50px;\",\n                    \".money-input-box\": \"height:75px;\",\n                    \".bill-info\": \"margin: 15px 20px 10px 20px;\",\n                    \".discount-subtitle\": \"font-size:15px;\",\n                    \".discount-title-desc\": \"font-size:14px;\",\n                    \".payment-container\": \"padding: 13px 20px 10px 20px;\",\n                    \".address\": \"margin: 0 20px 13px 20px; height:14px;\",\n                    \".address-text\": \"font-size: 12px\",\n                    \".discount-info\": \"padding-left: 20px; padding-right: 20px;\",\n                    \".discount-tip\": \"font-size:15px;\",\n                    \".money-label\": \"font-size: 17px;\",\n                    \".payment-money\": \"font-size: 36px; height: 42px;\",\n                    \".main-split-line\": \"margin: 0 20px 0 20px;\"\n                };\n                for (var x in style) {\n                    var els = document.querySelectorAll(x);\n                    if (!els) continue;\n                    for (var i = 0, l = els.length; i < l; i++) {\n                        els[i].style.cssText = style[x];\n                    }\n                }\n            },\n\n            // 根据服务端返回的数据,更新页面的显示\n            refreshDiscountAreaDisplay: function () {\n\n                // PS: alipayDiscount是布尔值\n                Node.splitLine.style.display = Utils.isValidArray(Biz.merchantDiscountList) || Biz.alipayDiscount ? 'flex' : 'none';\n                Page.MerchantDiscountList.display(Utils.isValidArray(Biz.merchantDiscountList) ? 'flex' : 'none');\n                Page.AlipayDiscountList.display(Biz.alipayDiscount ? 'flex' : 'none');\n            },\n\n            // 商家优惠列表\n            MerchantDiscountList: {\n                create: function (list) {\n                    // 标题栏位置的提示文字\n                    Node.merchantTips.innerText = list.length > 1 ? \"(不叠加享用)\" : \"\";\n                    Node.merchantDiscountList.innerHTML = \"\";\n                    for (var i = 0, l = list.length; i < l; i++) {\n                        Node.merchantDiscountList.appendChild(\n                                Page.MerchantDiscountList.createItem(list[i])\n                        );\n                    }\n                },\n                // 创建单条元素\n                createItem: function (info, highlight) {\n                    var discountItem = Utils.createElement(\"div.discount-item#\" + info.id);\n                    var title = Utils.createElement(\"label.discount-title \"\n                            + (Page.isBigIOSDevice ? \" discount-title-big \" : \"\")\n                            + (highlight ? \" discount-title-best \" : \"\")\n                            + \"[text=\" + (info.showName ? info.showName : \"\") + \"]\");\n                    var money = Utils.createElement(\"label.discount-money \"\n                            + (Page.isBigIOSDevice ? \" discount-money-big \" : \"\")\n                            + \"[text=\" + (info.payAmount ? info.payAmount : \"\") + \"]\");\n                    discountItem.appendChild(title);\n                    discountItem.appendChild(money);\n                    return discountItem;\n                },\n                reset: function () {\n                    var items = Node.merchantDiscountList.querySelectorAll(\".discount-item\");\n                    Node.merchantTips.innerText = items.length > 1 ? \"(不叠加享用)\" : \"\";\n                    var discountTitleClass = ' discount-title ' + (Page.isBigIOSDevice ? \" discount-title-big \" : \"\");\n                    for (var i = 0, l = items.length; i < l; i++) {\n                        items[i].querySelector('.discount-title').className = discountTitleClass;\n                        items[i].querySelector('.discount-money').innerText = '';\n                    }\n                },\n                highlight: function (list) {\n                    var items = Node.merchantDiscountList.querySelectorAll(\".discount-item\");\n                    if (list.length && items.length > 1) {\n                        Node.merchantTips.innerText = \"(不叠加享用，已选最优)\";\n                    } else {\n                        Node.merchantTips.innerText = \"\";\n                    }\n\n                    for (var i = 0, l = list.length; i < l; i++) {\n                        var itemOnThePage = false;\n                        var bestTitleClass = \"discount-title \" + (Page.isBigIOSDevice ? \" discount-title-big \" : \"\") + \" discount-title-best\";\n                        var titleClass = \"discount-title\" + (Page.isBigIOSDevice ? \" discount-title-big \" : \"\");\n                        for (var x = 0, y = items.length; x < y; x++) {\n                            if (list[i].id == items[x].id) {\n                                itemOnThePage = true;\n                                items[x].querySelector('.discount-title').className = bestTitleClass;\n                                items[x].querySelector('.discount-money').innerText = list[i].payAmount;\n                            } else {\n                                items[x].querySelector('.discount-title').className = titleClass;\n                                items[x].querySelector('.discount-money').innerText = \"\";\n                            }\n                        }\n                        if (!itemOnThePage) {\n                            // 如果匹配的优惠不在DOM列表中,则创建一新的并填充到页面\n                            Node.merchantDiscountList.appendChild(\n                                    Page.MerchantDiscountList.createItem(list[i], true)\n                            );\n                        }\n                    }\n                },\n                display: function (display) {\n                    Node.merchantDiscountList.style.display = display;\n                    Node.merchantDiscountTitle.style.display = display;\n                }\n            },\n\n            // 支付宝优惠列表\n            AlipayDiscountList: {\n                // 显示待计算\n                showAwaitingToCalculate: function () {\n                    Node.alipayDiscount.innerHTML = '';\n                    var discountItem = Utils.createElement('div.discount-item');\n                    var discountTip = Utils.createElement('label.discount-tip[text=输入金额后自动计算]');\n                    discountItem.appendChild(discountTip);\n                    Node.alipayDiscount.appendChild(discountItem);\n                },\n                // 创建支付折扣列表\n                create: function (list) {\n                    Node.alipayDiscount.innerHTML = '';\n                    for (var i = 0, l = list.length; i < l; i++) {\n                        Node.alipayDiscount.appendChild(\n                                Page.AlipayDiscountList.createItem(list[i])\n                        );\n                    }\n                },\n                // 创建一条支付宝打折信息\n                createItem: function (info) {\n                    var discountItem = Utils.createElement(\"div.discount-item#\" + info.id);\n                    var labelTitle = Utils.createElement(\"label.discount-title \"\n                            + (Page.isBigIOSDevice ? \" discount-title-big \" : \"\")\n                            + \"[text=\" +\n                            (info.showName ? info.showName : \"\") + \"]\");\n                    var amount = Utils.createElement(\"label.discount-money[text=\" +\n                            (info.payAmount ? info.payAmount : '') + \"]\");\n                    discountItem.appendChild(labelTitle);\n                    discountItem.appendChild(amount);\n                    return discountItem;\n                },\n                // 显示没有优惠\n                hasNoMore: function () {\n                    // 没有匹配到优惠\n                    Node.alipayDiscount.innerHTML = '';\n                    var item = Utils.createElement('div.discount-item');\n                    var tips = Utils.createElement('label.discount-tip[text=没有更多可享优惠了~]');\n                    item.appendChild(tips);\n                    Node.alipayDiscount.appendChild(item);\n                },\n                display: function (display) {\n                    Node.alipayDiscountContainer.style.display = display;\n                }\n            },\n\n            // 重置整个页面\n            reset: function () {\n                // 清空输入输出框\n                Node.discountedAmount.innerText = '';\n                Node.totalAmountInput.value = '';\n                Node.noDiscountAmountInput.value = '';\n                Page.lastTotalAmount = '';\n                Page.lastNoDiscount = '';\n                Node.paymentButton.disabled = true;\n                Node.splitLine.style.display = 'none';\n                Node.paymentInfo.style.display = 'none';\n                Node.paymentTips.style.display = 'none';\n\n                // 清空商家折扣区\n                Node.merchantDiscountList.innerHTML = '';\n                // 重置支付宝折扣区\n                Page.AlipayDiscountList.showAwaitingToCalculate();\n\n                // 清空服务端返回的数据\n                Biz.preQueryId = '';\n                Biz.preCalculateId = '';\n                Biz.merchantDiscountList = [];\n                Biz.alipayDiscount = false;\n            },\n\n\n            tipsTimer: undefined,\n            showCounting: function () {\n                // 3秒后的提示\n                if (Page.tipsTimer) {\n                    window.clearTimeout(Page.tipsTimer);\n                }\n                Page.tipsTimer = setTimeout(function () {\n                    document.invoke(\"toast\", {\n                        \"text\": \"网络信号不佳，直接点击“确认付款”也可享受最高优惠哦~\",\n                        \"type\": \"none\",\n                        \"duration\": 2000\n                    });\n                    Node.discountedAmount.innerText = Node.totalAmountInput.value;\n                }, 3000);\n\n            },\n\n            onkeydown: function () {\n                if (window.event.which == 10) {\n                    Node.totalAmountInput.blur();\n                    Node.noDiscountAmountInput.blur();\n                }\n            },\n\n            queryTimer: undefined,\n\n            prepareToCalclate: function () {\n\n                Utils.checkAmount();\n\n                if (Node.totalAmountInput.value * 1 == 0) {\n                    Page.MerchantDiscountList.reset();\n                    Page.AlipayDiscountList.showAwaitingToCalculate();\n                } else {\n                    // 重新请求列表\n                    Page.queryTimer = setTimeout(function () {\n                        Biz.queryMatchedDiscount();\n                    }, 800);\n                }\n            },\n\n            // 更新付款区域显示\n            updatePaymentDisplay: function (isReset) {\n                if (isReset || Node.totalAmountInput.value * 1 == 0) {\n                    Node.paymentButton.disabled = true;\n                    //Node.discountedAmount.innerText = '0.00';\n                    Node.paymentInfo.style.display = 'none';\n                    Node.paymentTips.style.display = 'none';\n                    if (isReset){\n                        Node.discountedAmount.innerText = \"<font size=14>计算中...</font>\";\n                    }\n                } else {\n                    Node.paymentButton.disabled = false;\n                    //Node.discountedAmount.innerText = Node.totalAmountInput.value;\n                    Node.paymentInfo.style.display = 'flex';\n                    Node.paymentTips.style.display = 'flex';\n                }\n            },\n\n            // 立即展示付款总金额，不拉取折扣匹配信息\n            updatePaymentDisplayImmediately: function () {\n                if (Node.totalAmountInput.value * 1 == 0) {\n                    Node.paymentButton.disabled = true;\n                    //Node.discountedAmount.innerText = '0.00';\n                    Node.paymentInfo.style.display = 'none';\n                    Node.paymentTips.style.display = 'none';\n                } else {\n                    Node.paymentButton.disabled = false;\n                    Node.discountedAmount.innerText = Node.totalAmountInput.value;\n                    Node.paymentInfo.style.display = 'flex';\n                    Node.paymentTips.style.display = 'flex';\n                }\n            },\n\n            // 绑定UI操作事件\n            bindEvent: function () {\n\n                // 点击支付按纽\n                Node.paymentButton.onclick = function () {\n                    Node.paymentButton.disabled = true;\n                    // 订单相关信息\n                    var orderInfo = {};\n                    orderInfo.amount = Node.totalAmountInput.value;\n                    orderInfo.exceptionAmount = Node.noDiscountAmountInput.value;\n                    orderInfo.discountCardList = [];\n\n                    Biz.createOrder(orderInfo);\n                };\n\n                Node.totalAmountInput.oninput = function () {\n                    if(Biz.firstRPCBizSuccess){\n\n                        Utils.formatMoneyOnInput(Node.totalAmountInput);\n                        if(Node.totalAmountInput.value * 1.0 != Page.lastTotalAmount * 1.0){\n\n                            if (Page.tipsTimer) clearTimeout(Page.tipsTimer);\n                            if (Page.queryTimer) clearTimeout(Page.queryTimer);\n                            \n                            if(Node.totalAmountInput.value * 1.0 < Node.noDiscountAmountInput.value * 1.0){\n                                Page.updatePaymentDisplayImmediately();\n                                Page.MerchantDiscountList.reset();\n                                Page.AlipayDiscountList.showAwaitingToCalculate();\n                                Page.prepareToCalclate();\n                                Node.paymentButton.disabled = true;\n                            }\n                            else{\n                                Page.updatePaymentDisplay(true);\n                                Page.MerchantDiscountList.reset();\n                                Page.AlipayDiscountList.showAwaitingToCalculate();\n                                Page.prepareToCalclate();\n                            }\n\n                        }\n                    }\n                    else{\n                        Utils.formatMoneyOnInput(Node.totalAmountInput);\n                        Page.updatePaymentDisplayImmediately();\n                        Page.prepareToCalclate();\n                        if(Node.totalAmountInput.value * 1.0 < Node.noDiscountAmountInput.value * 1.0){\n                            Node.paymentButton.disabled = true;\n                        }\n                    }\n                    Page.lastTotalAmount = Node.totalAmountInput.value * 1.0;\n\n                    // TODO: 为什么这里需要setTimeout?\n                    setTimeout(function () {\n                        document.setProp('keyboard', {\n                            \"textFieldId\": Node.totalAmountInput.id,\n                            \"submitEnable\": Node.totalAmountInput.value * 1 > 0\n                        });\n                    }, 0);\n                };\n\n                Node.noDiscountAmountInput.oninput = function () {\n                    if (Biz.firstRPCBizSuccess){\n\n                        Utils.formatMoneyOnInput(Node.noDiscountAmountInput);\n                        if (Node.noDiscountAmountInput.value * 1.0 != Page.lastNoDiscount * 1.0){\n\n                            if (Page.tipsTimer) clearTimeout(Page.tipsTimer);\n                            if (Page.queryTimer) clearTimeout(Page.queryTimer);\n\n                            if(Node.totalAmountInput.value * 1.0 < Node.noDiscountAmountInput.value * 1.0){\n                                Page.updatePaymentDisplayImmediately();\n                                Page.MerchantDiscountList.reset();\n                                Page.AlipayDiscountList.showAwaitingToCalculate();\n                                Page.prepareToCalclate();\n                                Node.paymentButton.disabled = true;\n                            }\n                            else{\n                                Page.updatePaymentDisplay(true);\n                                Page.MerchantDiscountList.reset();\n                                Page.AlipayDiscountList.showAwaitingToCalculate();\n                                Page.prepareToCalclate();\n                            }\n\n                        }\n                    }\n                    else{\n\n                        Utils.formatMoneyOnInput(Node.noDiscountAmountInput);\n                        Page.updatePaymentDisplayImmediately();\n                        Page.prepareToCalclate();\n                        if(Node.totalAmountInput.value * 1.0 < Node.noDiscountAmountInput.value * 1.0){\n                            Node.paymentButton.disabled = true;\n                        }\n                    }\n\n                    Page.lastNoDiscount = Node.noDiscountAmountInput.value * 1.0;\n\n                };\n\n                // 利用延时,防止在两个输入框之间切换时重复请求RPC\n                Node.totalAmountInput.onfocus = function () {\n                    document.invoke(\"log\",{\n                        \"actionId\":\"clicked\",\n                        \"extParams\":[\"allamt\"],\n                        \"appId\":\"20000238\",\n                        \"seed\":\"onlinepay\",\n                        \"ucId\":\"UC-KB-151222-150\"\n                    });\n                    //if (Page.queryTimer) clearTimeout(Page.queryTimer);\n                };\n                Node.noDiscountAmountInput.onfocus = function () {\n                    document.invoke(\"log\",{\n                        \"actionId\":\"clicked\",\n                        \"extParams\":[\"nodiscount\"],\n                        \"appId\":\"20000238\",\n                        \"seed\":\"onlinepay\",\n                        \"ucId\":\"UC-KB-151222-150\"\n                    });\n                    //if (Page.queryTimer) clearTimeout(Page.queryTimer);\n                };\n\n\n                Node.container.onclick = function () {\n                    Node.totalAmountInput.blur();\n                    Node.noDiscountAmountInput.blur();\n                }\n\n            }\n        };\n\n        var init = function () {\n\n            // 缓存必要的DOM元素\n            window.Node = {\n                totalAmountInput: $('J-total-amount-input'),\n                noDiscountAmountInput: $('J-no-discount-amount-input'),\n                alipayDiscountContainer: $('J-alipay-discount-container'),\n                alipayDiscount: $('J-alipay-discount'),\n                merchantDiscountList: $('J-merchant-discount-list'),\n                merchantDiscountTitle: $('J-merchant-discount-title'),\n                discountedAmount: $(\"J-discounted-amount\"),\n                paymentButton: $('J-payment-button'),\n                merchantTips: $('J-merchant-tips'),\n                addressText: $('J-address-text'),\n                addressBar: $('J-address'),\n                paymentTips: $('J-payment-tips'),\n                paymentInfo: $('J-payment-info'),\n                splitLine: $('J-split-line'),\n                container: $('J-container')\n            };\n\n            Page.isBigIOSDevice = (function () {\n                var result = false;\n                var platformInfo = document.getProp('platform');\n                if (platformInfo) {\n                    var platform = JSON.parse(platformInfo);\n                    if (platform.systemName == 'iPhone OS' && window.innerWidth >= 414) {\n                        result = true;\n                    }\n                }\n                return result;\n            })();\n\n            // 设置iPhone 6 Plus样式\n            if (Page.isBigIOSDevice) {\n                Page.loadBigIOSDeviceStyle();\n            }\n\n            Page.bindEvent();\n        };\n\n        document.onreload = function (data) {\n\n            if (data) {\n                Utils.mergeJSON(data, Biz);\n            }\n\n\n            if (Page.firstReloaded) {\n\n                // 更新地址栏\n                if (Biz.address) {\n                    if (window.innerWidth) {\n                        if (Page.isBigIOSDevice){\n                            Node.addressText.style.maxWidth = (window.innerWidth - 40 - 10 - 20 -30) + 'px';\n                        }\n                        else{\n                            Node.addressText.style.maxWidth = (window.innerWidth - 40 - 10 - 20) + 'px';\n                        }\n                    }\n                    Node.addressText.innerText = Biz.address;\n                    Node.addressBar.style.display = 'flex';\n                } else {\n                    Node.addressBar.style.display = 'none';\n                }\n                // 查询优惠列表\n                Biz.queryDiscountList();\n                Page.firstReloaded = false;\n            }\n        };\n\n        document.renderPageFinished = function () {\n            // 设置键盘样式(iOS only)\n            document.setProp('keyboard', {\n                \"textFieldId\": Node.totalAmountInput.id,\n                \"submitText\": \"完成\"\n            });\n            document.setProp('keyboard', {\n                \"textFieldId\": Node.noDiscountAmountInput.id,\n                \"submitText\": \"完成\"\n            });\n\n        };","tag":"text"}],"type":"text/javascript"}]},{"onload":"init();","tag":"body","children":[{"id":"J-container","tag":"div","children":[{"tag":"div","children":[{"id":"J-address","style":"display: none;","tag":"div","children":[{"tag":"img","src":"https://os.alipayobjects.com/rmsportal/gtHuBJyUhlwlmwC.png","css":"address-icon"},{"id":"J-address-text","tag":"label","css":"address-text"}],"css":"address"},{"tag":"div","children":[{"tag":"label","children":[{"text":"消费总金额(元):","tag":"text"}],"css":"payment-label payment-label-big"},{"id":"J-total-amount-input","placeholder":"请询问服务员后输入","tag":"input","value":"","onkeydown":"Page.onkeydown();","type":"money","css":"money-input big-money-input"}],"css":"input-box money-input-box"},{"style":"margin-top: 10px;","tag":"div","children":[{"tag":"label","children":[{"text":"不参与优惠金额(元):","tag":"text"}],"css":"payment-label"},{"id":"J-no-discount-amount-input","placeholder":"请询问服务员后输入","tag":"input","value":"","onkeydown":"Page.onkeydown();","type":"money","css":"money-input"}],"css":"input-box"}],"css":"bill-info"},{"id":"J-discount-info","tag":"div","children":[{"id":"J-merchant-discount-title","tag":"div","children":[{"tag":"label","children":[{"text":"商家优惠","tag":"text"}],"css":"discount-subtitle"},{"id":"J-merchant-tips","tag":"label","children":[{"text":"(不叠加享用)","tag":"text"}],"css":"discount-title-desc"}],"css":"discount-title-bar"},{"id":"J-merchant-discount-list","style":"display: none; margin-bottom: 10px;","tag":"div","css":"discount-item-container"},{"id":"J-alipay-discount-container","tag":"div","children":[{"tag":"div","css":"split-line"},{"tag":"label","children":[{"text":"口碑优惠","tag":"text"}],"css":"discount-subtitle"},{"id":"J-alipay-discount","style":"margin-bottom: 15px;","tag":"div","children":[{"tag":"div","children":[{"tag":"label","children":[{"text":"输入金额后自动计算","tag":"text"}],"css":"discount-tip"}],"css":"discount-item"}],"css":"discount-item-container"}],"css":"alipay-discount-container"}],"css":"discount-info"},{"id":"J-split-line","style":"margin: 0 15px 0 15px; display: none;","tag":"div","css":"split-line main-split-line"},{"tag":"div","children":[{"id":"J-payment-info","tag":"div","children":[{"tag":"label","children":[{"text":"还需付款(元)","tag":"text"}],"css":"money-label"},{"id":"J-discounted-amount","tag":"label","children":[{"text":"0.00","tag":"text"}],"css":"payment-money"}],"css":"payment-info"},{"id":"J-payment-button","tag":"button","children":[{"text":"确认付款","tag":"text"}],"css":"amc-btn-primary","disabled":"true"},{"tag":"div","children":[{"id":"J-payment-tips","tag":"label","children":[{"text":"请再次核对金额和门店信息","tag":"text"}],"css":"payment-tips"}],"css":"payment-tips-wrap"}],"css":"payment-container"}],"css":"container"}],"css":"body"}]},"format":"JSON","tplVersion":"5.0.5"}